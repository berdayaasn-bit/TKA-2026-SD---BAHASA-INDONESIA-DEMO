<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT Kuis - Belajar Sukses</title>
    <style>
        :root {
            --primary-blue: #0d6efd;
            --dark-blue: #1b437c;
            --bg-light: #f8f9fa;
            --border-color: #dee2e6;
            --text-main: #333;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; }
        body { margin: 0; padding: 0; background-color: var(--bg-light); color: var(--text-main); display: flex; flex-direction: column; min-height: 100vh; }
        
        /* HEADER CBT */
        .cbt-header { background: white; border-bottom: 2px solid var(--border-color); padding: 15px 30px; display: flex; justify-content: space-between; align-items: flex-end; }
        .header-left .soal-title { font-size: 1.1rem; color: #555; margin-bottom: 5px; }
        .header-left .soal-number { font-size: 1.8rem; font-weight: bold; color: black; }
        .header-left .font-controls { margin-top: 10px; font-size: 0.9rem; color: #666; }
        .font-controls span { cursor: pointer; margin: 0 5px; font-weight: bold; }
        .font-controls span:hover { color: var(--primary-blue); }
        
        .header-right { text-align: right; }
        .btn-header { background: var(--primary-blue); color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; font-weight: bold; margin-left: 5px; display: inline-flex; align-items: center;}
        .timer-pill { background: white; border: 1px solid #ccc; padding: 7px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; margin-left: 5px; display: inline-block;}
        .subject-title { margin-top: 10px; font-size: 1rem; font-weight: bold; color: #444; }

        /* MAIN CONTENT - SPLIT SCREEN */
        .cbt-body { flex: 1; padding: 20px 30px; display: flex; flex-direction: column; }
        .cbt-card { background: white; border: 1px solid #e0e0e0; border-radius: 8px; flex: 1; display: flex; box-shadow: 0 4px 6px rgba(0,0,0,0.02); overflow: hidden; font-size: 16px; /* Default Font Size */ transition: font-size 0.2s;}
        
        .cbt-left { flex: 1; padding: 30px; border-right: 2px dashed var(--border-color); overflow-y: auto; line-height: 1.6; }
        .cbt-right { flex: 1; padding: 30px; overflow-y: auto; line-height: 1.6; background: #fafafa; }
        
        img { max-width: 100%; height: auto; border-radius: 5px; margin: 10px 0; }
        .question-text { font-weight: 600; margin-bottom: 20px; }

        /* OPTIONS STYLING */
        .option-item { display: flex; align-items: flex-start; margin-bottom: 15px; cursor: pointer; padding: 8px; border-radius: 5px; transition: 0.2s;}
        .option-item:hover { background: #eef2f7; }
        .option-item input[type="radio"], .option-item input[type="checkbox"] { margin-top: 5px; margin-right: 15px; transform: scale(1.3); cursor: pointer;}
        
        /* TABLE BENAR/SALAH */
        .bs-table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        .bs-table th, .bs-table td { border: 1px solid var(--border-color); padding: 12px; text-align: center; }
        .bs-table td:first-child { text-align: left; width: 70%; }
        .bs-table th { background: #fdfdfd; color: #555; }
        .bs-table input[type="radio"] { transform: scale(1.3); cursor: pointer; }

        /* FOOTER NAV */
        .cbt-footer-nav { display: flex; justify-content: space-between; padding: 20px 30px; }
        .btn-nav { padding: 10px 25px; border-radius: 5px; border: none; font-weight: bold; font-size: 0.9rem; cursor: pointer; }
        .btn-prev { background: #fff; border: 1px solid #ccc; color: #333; }
        .btn-ragu { background: #ffc107; color: #000; }
        .btn-next { background: var(--primary-blue); color: white; }

        /* FOOTER BRANDING */
        .cbt-footer { background: var(--dark-blue); color: white; padding: 10px 30px; display: flex; justify-content: space-between; font-size: 0.8rem; }

        /* LOGIN & RESULT SCREENS */
        .screen { display: none; }
        .screen.active { display: flex; flex-direction: column; flex: 1; }
        .center-box { margin: auto; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 400px; }
        .center-box input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ccc; border-radius: 5px; font-size: 1.1rem; text-align: center; }
        .center-box .btn-submit { background: var(--primary-blue); color: white; width: 100%; padding: 12px; border: none; border-radius: 5px; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
        
        /* MODAL DAFTAR SOAL */
        #modal-grid { display: none; position: fixed; top: 0; right: 0; bottom: 0; width: 350px; background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.1); z-index: 100; padding: 20px; flex-direction: column; border-left: 4px solid var(--primary-blue);}
        .grid-header { display: flex; justify-content: space-between; font-weight: bold; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px;}
        .grid-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; overflow-y: auto; }
        .grid-btn { padding: 10px 0; text-align: center; border: 1px solid #ccc; border-radius: 5px; background: white; cursor: pointer; font-weight: bold; }
        .grid-btn.answered { background: #0d6efd; color: white; border-color: #0d6efd; }
        
        @media (max-width: 768px) {
            .cbt-card { flex-direction: column; }
            .cbt-left { border-right: none; border-bottom: 2px dashed #ccc; }
        }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <div class="center-box">
            <h2 style="color: var(--dark-blue); margin-top: 0;">Portal Ujian CBT</h2>
            <p style="color: #666;">Masukkan PIN Akses Kuis Anda</p>
            <input type="password" id="pin-input" placeholder="PIN UJIAN">
            <button class="btn-submit" onclick="startQuiz()">MASUK</button>
        </div>
    </div>

    <div id="screen-quiz" class="screen">
        <div class="cbt-header">
            <div class="header-left">
                <div class="soal-title">Soal nomor</div>
                <div class="soal-number" id="q-number">1</div>
                <div class="font-controls">
                    Ukuran font soal: 
                    <span style="font-size: 0.9em;" onclick="changeFontSize(14)">A</span>
                    <span style="font-size: 1.1em;" onclick="changeFontSize(18)">A</span>
                    <span style="font-size: 1.3em;" onclick="changeFontSize(22)">A</span>
                </div>
            </div>
            <div class="header-right">
                <button class="btn-header">INFORMASI SOAL</button>
                <div class="timer-pill">Sisa Waktu : <span id="timer-display">00:00:00</span></div>
                <button class="btn-header" onclick="toggleGrid()"><svg style="width:16px;height:16px;margin-right:5px;" viewBox="0 0 24 24"><path fill="currentColor" d="M3,3H9V9H3V3M15,3H21V9H15V3M3,15H9V21H3V15M15,15H21V21H15V15Z" /></svg> Daftar Soal</button>
                <div class="subject-title" id="subject-name">Matematika - SMP Sederajat</div>
            </div>
        </div>

        <div class="cbt-body">
            <div class="cbt-card" id="cbt-content-area">
                <div class="cbt-left" id="cbt-left">
                    </div>
                <div class="cbt-right" id="cbt-right">
                    </div>
            </div>
        </div>

        <div class="cbt-footer-nav">
            <button class="btn-nav btn-prev" id="btn-prev" onclick="navQuestion(-1)">SOAL SEBELUMNYA</button>
            <button class="btn-nav btn-ragu">RAGU-RAGU</button>
            <button class="btn-nav btn-next" id="btn-next" onclick="navQuestion(1)">SOAL SELANJUTNYA</button>
        </div>

        <div class="cbt-footer">
            <div>Belajar Sukses - Sistem CBT V8.0</div>
            <div>&copy; <span id="year"></span> Hak Cipta Dilindungi</div>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div class="center-box" style="max-width: 600px;">
            <h1 style="color: var(--dark-blue);">Ujian Selesai</h1>
            <p style="font-size: 1.2rem;">Nilai Akhir Anda:</p>
            <div style="font-size: 5rem; font-weight: bold; color: var(--primary-blue); border: 5px solid var(--primary-blue); width: 180px; height: 180px; line-height: 170px; border-radius: 50%; margin: 20px auto;">
                <span id="final-score">0</span>
            </div>
            <h3 id="result-msg"></h3>
            <button class="btn-submit" style="margin-top: 20px;" onclick="location.reload()">Selesai</button>
        </div>
    </div>

    <div id="modal-grid">
        <div class="grid-header">
            <span>Daftar Soal</span>
            <span style="cursor:pointer; color: red;" onclick="toggleGrid()">TUTUP X</span>
        </div>
        <div class="grid-container" id="grid-container">
            </div>
    </div>

<script>
    // ==========================================
    // 1. KONFIGURASI DATA UTAMA
    // ==========================================
    const JUDUL_KUIS = "TKA SD - BAHASA INDONESIA"; // Akan tampil di sudut kanan atas
    const PIN_AKSES = "SUKSES100%";
    const WAKTU_MENIT = 70;
    const TARGET_TOTAL_SOAL = 30; // Algoritma baru dijamin mencari 30 soal

    // [PENTING] PASTE KESELURUHAN DATA SOAL ANDA DI DALAM BACKTICK (`) DI BAWAH INI
    const RAW_DATA = `
[PASTE DATA RAW ANDA DI SINI - PASTIKAN SEMUA SOAL TUNGGAL DAN CLUSTER MASUK]
`;

    // ==========================================
    // 2. NEW ROBUST MIXER ENGINE V8.0
    // ==========================================
    let RAW_SINGLE = [];
    let RAW_CLUSTER = [];
    let finalQuestionList = [];
    let userAnswers = {};
    let currentQIndex = 0;
    let timerInterval;
    let timeLeft = WAKTU_MENIT * 60;

    document.getElementById('subject-name').innerText = JUDUL_KUIS;
    document.getElementById('year').innerText = new Date().getFullYear();

    function parseRawData() {
        const singleBlock = RAW_DATA.split('--- START SOAL TUNGGAL ---')[1]?.split('--- END SOAL TUNGGAL ---')[0] || "";
        const clusterBlock = RAW_DATA.split('--- START SOAL CLUSTER ---')[1]?.split('--- END SOAL CLUSTER ---')[0] || "";

        singleBlock.split('\n').forEach(line => {
            if (line.trim().startsWith('[')) RAW_SINGLE.push(line.trim());
        });

        clusterBlock.split('###').forEach(block => {
            if (block.trim()) {
                let lines = block.trim().split('\n');
                let wacana = "";
                let qs = [];
                lines.forEach(l => {
                    if (l.startsWith('[WACANA:')) wacana += l.replace('[WACANA:', '').replace(']', '').trim() + "<br><br>";
                    else if (l.trim().startsWith('[')) qs.push(l.trim());
                });
                if (qs.length > 0) RAW_CLUSTER.push({ wacana, questions: qs });
            }
        });
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function generateMixer() {
        // Persiapkan pool data
        let singlePool = shuffleArray(RAW_SINGLE.map(q => ({ wacana: null, raw: q })));
        let clusterPool = shuffleArray(RAW_CLUSTER.map(c => ({ wacana: c.wacana, questions: [...c.questions] })));
        let qList = [];

        // Fungsi bantu Tarik Soal Tunggal
        const pullSingles = (n) => {
            for(let i=0; i<n; i++) {
                if(singlePool.length > 0) qList.push(singlePool.pop());
            }
        };

        // Fungsi bantu Tarik Soal Cluster (Max 2 per putaran agar merata)
        const pullClusters = (n) => {
            let pulled = 0;
            let loopCount = 0; // Mencegah infinite loop
            while(pulled < n && clusterPool.length > 0 && loopCount < 100) {
                let c = clusterPool[loopCount % clusterPool.length];
                if (c.questions.length > 0) {
                    qList.push({ wacana: c.wacana, raw: c.questions.pop() });
                    pulled++;
                }
                loopCount++;
                clusterPool = clusterPool.filter(cl => cl.questions.length > 0);
            }
        };

        // Eksekusi Urutan (Bug Fixed: Dijamin menyentuh kuota asalkan data cukup)
        pullSingles(3);    // No 1-3
        pullClusters(7);   // No 4-10
        pullSingles(3);    // No 11-13
        pullClusters(7);   // No 14-20
        
        // Penuhi sisa kuota hingga mencapai TARGET_TOTAL_SOAL (30)
        let remainingNeeded = TARGET_TOTAL_SOAL - qList.length;
        if (remainingNeeded > 0) {
            let leftovers = [];
            leftovers.push(...singlePool);
            clusterPool.forEach(c => {
                c.questions.forEach(q => leftovers.push({ wacana: c.wacana, raw: q }));
            });
            shuffleArray(leftovers);
            
            for(let i=0; i<remainingNeeded; i++) {
                if(leftovers.length > 0) qList.push(leftovers.pop());
            }
        }

        finalQuestionList = qList;
        buildGrid();
    }

    // ==========================================
    // 3. UI RENDER ENGINE (SPLIT SCREEN CBT)
    // ==========================================
    function parseString(str) {
        return str.replace(/\[IMG:\s*(.+?)\]/g, '<img src="$1" alt="Gambar Pendukung">');
    }

    function changeFontSize(px) {
        document.getElementById('cbt-content-area').style.fontSize = px + 'px';
    }

    function renderQuestion(index) {
        if(index < 0 || index >= finalQuestionList.length) return;
        currentQIndex = index;
        let qData = finalQuestionList[index];
        let parts = qData.raw.split('|').map(s => s.trim());
        
        let qType = parts[0].match(/\[Tipe:\s*([^\]]+)\]/)[1];
        let qText = parts[0].replace(/\[Tipe:\s*[^\]]+\]/, '').trim();
        let optionsStr = parts[1] || "";

        document.getElementById('q-number').innerText = index + 1;
        
        let leftPane = document.getElementById('cbt-left');
        let rightPane = document.getElementById('cbt-right');
        
        // LOGIKA PEMBAGIAN LAYAR (Sesuai Gambar Referensi)
        if (qData.wacana) {
            // Jika ada Wacana (Cluster): Wacana di Kiri, Soal & Opsi di Kanan
            leftPane.innerHTML = parseString(qData.wacana);
            rightPane.innerHTML = `<div class="question-text">${parseString(qText)}</div>`;
        } else {
            // Jika Soal Tunggal: Soal di Kiri, Opsi di Kanan
            leftPane.innerHTML = `<div class="question-text" style="font-size:1.1em;">${parseString(qText)}</div>`;
            rightPane.innerHTML = `<div class="question-text" style="color:#666; font-size:0.9em; border-bottom: 1px solid #ddd; padding-bottom:10px;">Pilih jawaban yang paling tepat:</div>`;
        }

        // RENDER OPSI JAWABAN (Di Kolom Kanan)
        let opts = optionsStr.split('~').map(s => s.trim());
        
        if (qType === 'BS') {
            let tableHTML = `<table class="bs-table"><tr><th>Pernyataan</th><th width="70">Benar</th><th width="70">Salah</th></tr>`;
            opts.forEach((opt, i) => {
                let stmtMatch = opt.match(/(.+?)\s*\((Benar|Salah)\)/i);
                let stmtText = stmtMatch ? stmtMatch[1] : opt;
                let savedAns = userAnswers[`${index}_${i}`] || "";
                
                tableHTML += `<tr>
                    <td>${parseString(stmtText)}</td>
                    <td><input type="radio" name="bs_${index}_${i}" value="Benar" onchange="saveAnswer('${index}_${i}', 'Benar')" ${savedAns==='Benar'?'checked':''}></td>
                    <td><input type="radio" name="bs_${index}_${i}" value="Salah" onchange="saveAnswer('${index}_${i}', 'Salah')" ${savedAns==='Salah'?'checked':''}></td>
                </tr>`;
            });
            tableHTML += `</table>`;
            rightPane.innerHTML += tableHTML;
        } 
        else if (qType === 'PGK') {
            opts.forEach((opt, i) => {
                let val = String.fromCharCode(65 + i);
                let savedArr = userAnswers[index] || [];
                rightPane.innerHTML += `<label class="option-item">
                    <input type="checkbox" name="q_${index}" value="${val}" onchange="saveAnswerPGK(${index}, '${val}', this.checked)" ${savedArr.includes(val)?'checked':''}> 
                    <span>${val}. ${parseString(opt)}</span>
                </label>`;
            });
        }
        else { // Standar PG
            opts.forEach((opt, i) => {
                let val = String.fromCharCode(65 + i);
                let savedAns = userAnswers[index] || "";
                rightPane.innerHTML += `<label class="option-item">
                    <input type="radio" name="q_${index}" value="${val}" onchange="saveAnswer('${index}', '${val}')" ${savedAns===val?'checked':''}> 
                    <span>${val}. ${parseString(opt)}</span>
                </label>`;
            });
        }

        // Navigasi Bawah
        document.getElementById('btn-prev').style.visibility = index === 0 ? 'hidden' : 'visible';
        let btnNext = document.getElementById('btn-next');
        if(index === finalQuestionList.length - 1) {
            btnNext.innerText = "SELESAI UJIAN";
            btnNext.style.background = "#28a745"; // Warna Hijau
            btnNext.onclick = confirmFinish;
        } else {
            btnNext.innerText = "SOAL SELANJUTNYA";
            btnNext.style.background = "var(--primary-blue)";
            btnNext.onclick = () => navQuestion(1);
        }
        
        updateGridUI();
    }

    // ==========================================
    // 4. LOGIKA JAWABAN & NAVIGASI GRID